/*
 * Kernel stack overflow basics
 * https://blog.0x80.org/kernel-stack-overflows-basics/
 */

#include <linux/kernel.h>
#include <linux/module.h>
#include <linux/proc_fs.h>
#include <linux/string.h>
#include <linux/vmalloc.h>
#include <linux/sched.h>
#include <linux/uaccess.h>

struct proc_dir_entry *proc_file_entry;
uint64_t rbx, rbp;
// Buggy write handling
int buggy_write(struct file *file,
        const char *buf,
        unsigned long len) {

    char data[8];
    /*asm("addq $0x8, %%rsp;\n"
        "popq %0;\n"
        "popq %1;\n"
        "subq $0x8, %%rsp;\n"
        : "=r"(rbx),"=r"(rbp)::"memory");*/
    copy_from_user(data, buf, len);
    /*asm("addq $0x8, %%rsp;\n"
        "pushq %0;\n"
        "pushq %1;\n"
        "subq $0x8, %%rsp;\n"
        : :"r"(rbp),"r"(rbx));*/
    //printk(" buggy_write %s data=(%p) len=%d\n", buf,(void*)data, len);
    return len;
}

static struct file_operations buggy_proc_fops = {
  .write = buggy_write,
};

int init_module()
{
    printk(" module started\n");
    printk(" creating proc entry @ /proc/buggy\n");

    // handle anything written to /proc/buggy
    // pass it to buggy_write
    proc_file_entry = proc_create("buggy", 0666, NULL, &buggy_proc_fops);

    return 0;
}

void cleanup_module()
{
    remove_proc_entry("buggy", NULL);
}
